# 值类型化回归测试与性能验证计划

## 目标
- 证明 `ScriptDatum` 改造对功能无回归。
- 量化常见脚本在值类型化后的性能与内存改进。

## 功能回归清单
1. **算术与逻辑**  
   - `unit.as`、`md5.as` 中的数值运算、位运算。
   - 自增/自减、复合赋值链路。
2. **闭包与捕获变量**  
   - 验证 `forTest` 等循环中捕获变量的读写。
   - `testClouse`（闭包递增）返回值正确。
3. **数组与映射**  
   - 数组创建、读写（`NEW_ARRAY`、`SET_ELEMENT`）及迭代。
   - Map 属性访问与删除。
4. **CLR 互操作**  
   - 已注册类型的构造、静态/实例方法、字段读写。
   - 边界：`null`/`bool`/数值参数转换。
5. **异常与跳转**  
   - `try` 逻辑（若存在）、跳转指令（`JUMP_IF_TRUE/FALSE`）的栈恢复。

## 性能基准建议
- **算术循环**：对比 `forTest`、`MD5` 计算（10^6 次循环）。
- **数组推入与遍历**：持续 `push` / `pop`，验证 `ScriptDatum` 栈的增益。
- **CLR 调用**：重复构造、方法调用（如 `StringBuilder` append），测量参数转换开销。
- **内存跟踪**：使用 .NET `GC.GetAllocatedBytesForCurrentThread()` 捕获前后差异。

## 自动化思路
- 在 `Examples/tests` 中添加脚本期望值断言（输出/日志）。✅ 已添加 `benchmarkNumbers` 等脚本。
- 新增 Host 侧基准程序，复用 `Examples` 项目，记录执行耗时/分配。✅ `BenchmarkScript` 已落地，输出时间与分配量。
- 将关键测试纳入 CI：构建脚本 → 运行基准 → 比较历史记录（允许浮动）。

## 下一步
1. 实现 Host 侧基准工具（可在 `Examples` 项目中添加独立命令）。
2. 为上述功能回归编写断言或快照测试。
3. 集成性能指标输出，便于后续值类型化微调时做回归比较。

